<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å™¶é™€ä»çåƒå¯¶èª²ç¨‹å¹³å°</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", "Microsoft JhengHei", "Jomolhari", "Microsoft Himalaya", "Kailash", sans-serif; /* æ·»åŠ è—æ–‡å­—é«” */
    /* Jomolhari æ˜¯ä¸€å€‹å¸¸ç”¨çš„é–‹æºè—æ–‡å­—é«” */
            background-color: #f8f9fa;
            color: #343a40; /* æ·±ç°è‰²æ–‡å­— */
            overflow-x: hidden;
            line-height: 1.6;
        }

        .hidden { display: none !important; }

        /* ========== é¦–é æ–°æ¨£å¼ ========== */
        .landing-page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* æ›¿æ›ç‚ºä½ çš„èƒŒæ™¯åœ–ç‰‡ URLï¼Œæˆ–ä½¿ç”¨æ¼¸è®Š */
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'); /* ç¤ºä¾‹åœ–ç‰‡ï¼Œè«‹æ›¿æ› */
            background-size: cover;
            background-position: center;
            color: white; /* æ–‡å­—é¡è‰²æ”¹ç‚ºç™½è‰²ä»¥é©æ‡‰æ·±è‰²èƒŒæ™¯ */
            text-align: center;
            padding: 2rem;
        }

        .landing-content-wrapper {
            max-width: 800px;
            animation: fadeInScaleUp 1s ease-out forwards;
        }

        @keyframes fadeInScaleUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .landing-title {
            font-size: 3rem; /* æ ¹æ“šéœ€è¦èª¿æ•´ */
            font-weight: 700; /* åŠ ç²— */
            margin-bottom: 1rem;
            line-height: 1.2;
            /* letter-spacing: 1px; */ /* å¯é¸çš„å­—é–“è· */
        }

        .landing-subtitle {
            font-size: 1.25rem;
            margin-bottom: 2.5rem;
            opacity: 0.9;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .landing-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap; /* åœ¨å°å±å¹•ä¸Šæ›è¡Œ */
        }

        .landing-btn {
            padding: 0.9rem 2.2rem;
            border-radius: 30px; /* æ›´åœ“æ½¤çš„æŒ‰éˆ• */
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            border: 2px solid transparent; /* ç‚º secondary æŒ‰éˆ•æº–å‚™é‚Šæ¡†ç©ºé–“ */
        }

        .landing-btn.primary {
            background-color: white;
            color: #8A6D46; /* æ·±ä¸€é»çš„æ£•é‡‘è‰² */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .landing-btn.primary:hover {
            background-color: #f8f0e3; /* æ·ºç±³è‰²æ‡¸åœ */
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .landing-btn.secondary {
            background-color: transparent;
            color: white;
            border-color: white;
        }
        .landing-btn.secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        /* --- é ‚éƒ¨å°èˆªæ¬„æ¨£å¼ (ç¢ºä¿æ¨™é¡Œå®Œæ•´é¡¯ç¤º) --- */
        .top-nav {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 1.5rem; /* ç¨å¾®æ¸›å°‘ padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-left { display: flex; align-items: center; gap: 0.75rem; /* èª¿æ•´ gap */ }
        .logo { /* ç”¨æ–¼ä¸»æ‡‰ç”¨ç¨‹å¼é ‚éƒ¨å°èˆª */
            display: flex;
            align-items: center;
            gap: 0.6rem; /* èª¿æ•´logoåœ–ç¤ºå’Œæ–‡å­—é–“è· */
            font-size: 1.1rem; /* å¯é©ç•¶èª¿æ•´ */
            font-weight: 600;
            color: #685335; /* æ·±ä¸€é»çš„æ£•è‰²ï¼Œç¢ºä¿å¯è®€æ€§ */
            text-decoration: none;
            cursor: pointer;
            white-space: nowrap; /* é˜²æ­¢æ¨™é¡Œæ›è¡Œ */
        }
        .logo-icon { /* ç”¨æ–¼ä¸»æ‡‰ç”¨ç¨‹å¼é ‚éƒ¨å°èˆª */
            width: 30px; /* ç¨å¾®èª¿æ•´å¤§å° */
            height: 30px;
            background: linear-gradient(135deg, #8B6F47, #B08D57); /* èª¿æ•´æ¼¸è®Š */
            border-radius: 6px; /* æ”¹ç‚ºåœ“è§’çŸ©å½¢ */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem; /* èª¿æ•´åœ–ç¤ºå…§æ–‡å­—å¤§å° */
            flex-shrink: 0; /* é˜²æ­¢åœ–ç¤ºè¢«å£“ç¸® */
        }

        /* (ä¿ç•™ä½ ç¬¬äºŒä»½ç¨‹å¼ç¢¼ä¸­ .nav-links, .nav-right, .user-menu, .user-avatar ç­‰æ¨£å¼ï¼Œ
           ä»¥åŠ .main-container, .course-sidebar, .content-area, .auth-modal ç­‰ä¸»é«”æ¨£å¼)
           é€™è£¡çœç•¥äº†å¤§é‡ä½ ä¹‹å‰å·²æœ‰çš„ CSSï¼Œåªå±•ç¤ºé—œéµä¿®æ”¹å’Œæ–°å¢éƒ¨åˆ†
        */
        /* ... é€™è£¡æ‡‰è©²æ˜¯ä½ ä¹‹å‰ç‰ˆæœ¬ä¸­ mainApp ç›¸é—œçš„ CSS ... */
        .main-container { margin-top: 60px; display: flex; height: calc(100vh - 60px); }
        .course-sidebar { width: 300px; background: #fff; border-right: 1px solid #e0e0e0; overflow-y: auto; flex-shrink: 0; padding-bottom: 60px; }
        .course-header { padding: 1.25rem; border-bottom: 1px solid #e0e0e0; }
        .course-title-main { font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 0.5rem; }
         .chapter-list { padding: 0.5rem 0; }
        .chapter { margin-bottom: 0.25rem; }
        .chapter-title { padding: 0.75rem 1.5rem; font-size: 0.9rem; font-weight: 500; color: #555; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; border-top: 1px solid #eee; }
        .chapter-title:first-child { border-top: none; }
        .chapter-title:hover { background: #e9ecef; }
        .chapter-icon { font-size: 0.75rem; transition: transform 0.2s; }
        .chapter.expanded .chapter-icon { transform: rotate(90deg); }
        .lesson-list { max-height: 0; overflow: hidden; transition: max-height 0.35s cubic-bezier(0.25, 0.1, 0.25, 1); background-color: #fff; }
        .chapter.expanded .lesson-list { max-height: 1000px; }
        .lesson { padding: 0.8rem 1rem 0.8rem 2.5rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; transition: background 0.2s; position: relative; border-bottom: 1px solid #f0f0f0;}
        .lesson:last-child { border-bottom: none; }
        .lesson:hover { background: #f1f3f5; }
        .lesson.active { background: #FFF3E0; color: #8B6F47; font-weight: 500; }
        .lesson.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #D4A574; border-top-right-radius: 2px; border-bottom-right-radius: 2px; }
        .lesson-icon-wrapper { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .lesson-icon { width: 18px; height: 18px; border-radius: 50%; border: 1.5px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #999; }
        .lesson.locked .lesson-icon::after { content: "ğŸ”’"; font-size: 0.8em; color: #aaa; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); }
        .lesson.locked { opacity: 0.6; cursor: not-allowed; background-image: repeating-linear-gradient(-45deg, transparent, transparent 4px, rgba(0,0,0,0.02) 4px, rgba(0,0,0,0.02) 8px); }
        .lesson-info { flex: 1; }
        .lesson-title { font-size: 0.875rem; color: #333; margin-bottom: 0.1rem; }
        .lesson.active .lesson-title { color: #8B6F47; }
        .lesson-duration { font-size: 0.75rem; color: #999; }

        /* å½±ç‰‡å’Œå…§å®¹å€åŸŸ */
        .content-area { flex: 1; background: #f0f2f5; overflow-y: auto; display: flex; flex-direction: column; }
        .video-section { background: #000; position: relative; padding-bottom: 56.25%; overflow: hidden; width: 100%; flex-shrink: 0;}
        .video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .video-container iframe { width: 100%; height: 100%; border: none; }
        .content-section { background: #fff; margin: 1rem; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex-grow: 1; display: flex; flex-direction: column; }
        .content-tabs { display: flex; border-bottom: 1px solid #e0e0e0; background: #fdfdfd; flex-shrink: 0; }
        .content-tab { padding: 0.8rem 1.5rem; cursor: pointer; color: #666; font-size: 0.9rem; font-weight: 500; position: relative; transition: all 0.2s; }
        .content-tab:hover { color: #333; }
        .content-tab.active { color: #8B6F47; }
        .content-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: #8B6F47; }
        .tab-content-wrapper { overflow-y: auto; flex-grow: 1; }
        .tab-content { padding: 1.5rem; display: none; }
        .tab-content.active { display: block; }
        #currentLessonTitle { font-size: 1.4rem; margin-bottom: 0.75rem; color: #333; font-weight: 600; } /* èª¿æ•´èª²ç¨‹æ¨™é¡Œå¤§å° */
        .tab-content h3 { font-size: 1.1rem; margin-bottom: 1rem; color: #333; }
        .tab-content p, .tab-content div { line-height: 1.7; color: #555; margin-bottom: 1rem; font-size: 0.9rem; }
        .bottom-controls { flex-shrink: 0; background: #fff; border-top: 1px solid #e0e0e0; padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .control-btn { padding: 0.6rem 1.2rem; border: 1px solid #e0e0e0; border-radius: 6px; background: #fff; color: #666; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;}
        .control-btn:hover { background: #f8f9fa; border-color: #8B6F47; color: #8B6F47; }
        .control-btn.primary { background: #8B6F47; color: white; border-color: #8B6F47; }
        .control-btn.primary:hover { background: #7A5F3C; }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }


        /* ç™»å…¥æ¨¡æ…‹æ¡† (èˆ‡ä¹‹å‰ç‰ˆæœ¬é¡ä¼¼ï¼Œå¯æ ¹æ“šéœ€è¦èª¿æ•´) */
        .auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .auth-form { background: white; padding: 2.5rem; border-radius: 12px; width: 400px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative; animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes zoomIn { from { opacity:0; transform: scale(0.9); } to { opacity:1; transform: scale(1); } }
        .auth-header { text-align: center; margin-bottom: 1.5rem; }
        .auth-logo-modal { width: 50px; height: 50px; background: linear-gradient(135deg, #8B6F47, #D4A574); border-radius: 10px; margin: 0 auto 0.75rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; font-weight: bold;}
        #authFormTitle { font-size: 1.5rem; color: #333; font-weight: 600; }
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; margin-bottom: 0.4rem; color: #555; font-size: 0.875rem; font-weight: 500;}
        .form-input { width: 100%; padding: 0.75rem 1rem; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: #8B6F47; box-shadow: 0 0 0 2px rgba(139, 111, 71, 0.1); }
        .auth-submit-btn { width: 100%; padding: 0.8rem; background: #8B6F47; color: white; border: none; border-radius: 6px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 0.5rem; }
        .auth-submit-btn:hover { background: #7A5F3C; }
        .auth-switch { text-align: center; margin-top: 1.25rem; color: #666; font-size: 0.875rem; }
        .auth-switch a { color: #8B6F47; text-decoration: none; font-weight: 500; }
        .auth-switch a:hover { text-decoration: underline; }
        .close-modal-btn { position: absolute; top: 1rem; right: 1rem; width: 30px; height: 30px; border: none; background: #f0f0f0; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #888; font-size: 1.1rem; transition: all 0.2s;}
        .close-modal-btn:hover { background: #e0e0e0; color: #555; }
        .error-message-modal { color: #dc3545; font-size: 0.8rem; margin-bottom: 1rem; text-align: center; min-height: 1em;}
        .success-message-modal { color: #28a745; font-size: 0.8rem; margin-bottom: 1rem; text-align: center; min-height: 1em;}
        .loading-spinner { display: inline-block; width: 18px; height: 18px; border: 2.5px solid #f3f3f3; border-top: 2.5px solid #8B6F47; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #welcomeContent { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 2rem; color: #777; }
        #welcomeContent h1 { font-size: 1.8rem; margin-bottom: 0.75rem; color: #444; }
        #welcomeContent p { font-size: 1rem; margin-bottom: 1.5rem; }
        #welcomeContent img { max-width: 100%; width: 350px; height: auto; border-radius: 8px; opacity: 0.6; } /* èª¿æ•´åœ–ç‰‡å¤§å°å’Œé€æ˜åº¦ */

  /* åœ¨ body æˆ–ä¸€å€‹é€šç”¨é¸æ“‡å™¨ä¸­å®šç¾©è—æ–‡å­—é«” (å¦‚æœç³»çµ±æ²’æœ‰åˆé©çš„ï¼Œéœ€è¦å¼•å…¥) */
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", "Microsoft JhengHei", "Jomolhari", "Microsoft Himalaya", "Kailash", sans-serif; /* æ·»åŠ è—æ–‡å­—é«” */
    /* Jomolhari æ˜¯ä¸€å€‹å¸¸ç”¨çš„é–‹æºè—æ–‡å­—é«” */
}

/* é¦–é å¤šèªè¨€æ¨™é¡Œ */
.landing-title-multilang {
    margin-bottom: 1.5rem;
    line-height: 1.3;
}
.landing-title-multilang div {
    display: block; /* æ¯ç¨®èªè¨€ä¸€è¡Œ */
}
.lang-tibetan {
    font-size: 2.2rem; /* è—æ–‡å¯ä»¥ç¨å¾®å¤§ä¸€é»æˆ–æ ¹æ“šå¯¦éš›èª¿æ•´ */
    font-family: "Jomolhari", "Microsoft Himalaya", "Kailash", serif; /* æŒ‡å®šè—æ–‡å­—é«” */
    margin-bottom: 0.5rem;
    font-weight: 500;
     color: #FFD700; /* é‡‘è‰²è—æ–‡ */
     text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
}
.lang-chinese {
    font-size: 2.8rem; /* ä¸»æ¨™é¡Œä¸­æ–‡ */
    font-weight: 700;
    margin-bottom: 0.3rem;
     /* color: white; /* å·²åœ¨ landing-page-container è¨­å®š */
}
.lang-english {
    font-size: 1.1rem;
    font-weight: 400;
    opacity: 0.85;
    letter-spacing: 0.5px;
}

/* ä¸»æ‡‰ç”¨é ‚éƒ¨å°èˆªå¤šèªè¨€æ¨™é¡Œ */
.logo-text-multilang {
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ— */
    line-height: 1.1; /* èª¿æ•´è¡Œé«˜ä½¿æ–‡å­—æ›´ç·Šæ¹Š */
    align-items: flex-start; /* å·¦å°é½Š */
}
.logo-text-multilang span {
    display: block;
    white-space: nowrap; /* é˜²æ­¢æ›è¡Œ */
    overflow: hidden;
    text-overflow: ellipsis; /* è¶…å‡ºé¡¯ç¤ºçœç•¥è™Ÿ */
    max-width: 350px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œæ ¹æ“šéœ€è¦èª¿æ•´ */
}
.lang-tibetan-nav {
    font-size: 0.75rem; /* å°èˆªæ¬„è—æ–‡å°ä¸€é» */
    font-family: "Jomolhari", "Microsoft Himalaya", "Kailash", serif;
    color: #795548; /* æ·±ä¸€é»çš„æ£•è‰² */
    margin-bottom: 1px;
}
.lang-chinese-nav {
    font-size: 0.95rem; /* å°èˆªæ¬„ä¸­æ–‡ */
    font-weight: 600;
    color: #5D4037; /* ä¸»æ¨™é¡Œé¡è‰² */
}
.lang-english-nav {
    font-size: 0.65rem;
    color: #A1887F; /* æ·ºä¸€é»çš„æ£•è‰² */
    font-weight: 400;
}
.logo { /* ç¢ºä¿ logo å®¹å™¨èƒ½å®¹ç´å¤šè¡Œæ–‡å­— */
    align-items: center; /* å‚ç›´å±…ä¸­åœ–ç¤ºå’Œæ–‡å­—å¡Š */
}


/* ç”¨æˆ¶ä¸‹æ‹‰é¸å–®æ¨£å¼ */
.user-menu-container {
    position: relative; /* ç‚ºä¸‹æ‹‰é¸å–®å®šä½ */
}
.user-menu {
    /* ... ä¿ç•™ä¹‹å‰çš„æ¨£å¼ ... */
    padding-right: 0.8rem; /* ç‚ºç®­é ­ç•™ç©ºé–“ */
}
.dropdown-arrow {
    font-size: 0.7rem;
    margin-left: 5px;
    transition: transform 0.2s ease-in-out;
}
.user-menu-container.open .dropdown-arrow {
    transform: rotate(180deg);
}

.user-dropdown {
    position: absolute;
    top: calc(100% + 8px); /* åœ¨ç”¨æˆ¶é¸å–®ä¸‹æ–¹ï¼Œå¸¶ä¸€é»é–“è· */
    right: 0;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    width: 220px; /* ä¸‹æ‹‰é¸å–®å¯¬åº¦ */
    z-index: 110; /* é«˜æ–¼å…¶ä»–å…ƒç´  */
    overflow: hidden;
    border: 1px solid #eee;
    animation: fadeInDropdown 0.2s ease-out;
}

@keyframes fadeInDropdown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.dropdown-user-info {
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
}
.dropdown-user-info strong {
    display: block;
    font-size: 0.95rem;
    color: #333;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.dropdown-user-info span {
    font-size: 0.8rem;
    color: #777;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dropdown-item {
    display: block;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    color: #555;
    text-decoration: none;
    transition: background-color 0.15s ease-in-out;
}
.dropdown-item:hover {
    background-color: #f8f9fa;
    color: #8B6F47;
}
.dropdown-item:not(:last-child) {
    border-bottom: 1px solid #f5f5f5;
}

 </style>
</head>
<body>
    <!-- é¦–é  -->
   <div id="landingPageContainer" class="landing-page-container">
    <!-- é¦–é çš„é ‚éƒ¨å°èˆªå¯ä»¥ä¿ç•™ï¼Œæˆ–è€…æ ¹æ“šæ–°è¨­è¨ˆèª¿æ•´/ç§»é™¤ -->
    <!-- ä¾‹å¦‚ï¼Œå¦‚æœæ–°é¦–é è¨­è¨ˆæ˜¯å…¨å±èƒŒæ™¯ï¼Œé ‚éƒ¨å°èˆªå¯èƒ½ä¸éœ€è¦æˆ–éœ€è¦ä¸åŒæ¨£å¼ -->
    <!-- ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å…ˆå‡è¨­ä½ å¸Œæœ›é¦–é é ‚éƒ¨æ˜¯ä¹¾æ·¨çš„ï¼Œåªæœ‰ä¸»è¦å…§å®¹ -->

    <div class="landing-content-wrapper"> <!-- é€™æ˜¯æ–°çš„å…§å®¹å®¹å™¨ -->
        <div class="landing-title-multilang">
            <div class="lang-tibetan">à¼„à¼…à¼ à¼à½€à½¿à½à½¼à½‚à¼‹à½¢à½²à½‚à¼‹à½ à½›à½²à½“à¼‹à½†à½ºà½“à¼‹à½”à½¼à½ à½²à¼‹à½†à½¼à½¦à¼‹à½€à¾±à½²à¼‹à½¦à¾Ÿà½ºà½‚à½¦à¼‹à½–à½´à¼</div>
            <div class="lang-chinese">å™¶é™€ä»çåƒå¯¶èª²ç¨‹å¹³å°</div>
            <div class="lang-english">Kathog Rigzin Chenpo Dharma Platform</div>
        </div>
        <p class="landing-subtitle">
            æ¢ç´¢ä½›é™€çš„æ™ºæ…§ï¼Œé–‹å•Ÿå…§å¿ƒçš„å¹³éœèˆ‡è¦ºç…§ã€‚ç³»çµ±åŒ–èª²ç¨‹ï¼Œå¼•é ˜æ‚¨é€æ­¥æ·±å…¥ç¶“è—ã€‚
        </p>
        <div class="landing-buttons"> <!-- æ²¿ç”¨ä¹‹å‰çš„æŒ‰éˆ•ï¼Œä½†é¡åå¯èƒ½éœ€è¦çµ±ä¸€ -->
            <button class="landing-btn primary" onclick="enterAsGuest()">
                é–‹å§‹å­¸ç¿’
            </button>
            <button class="landing-btn secondary" onclick="showAuthModal('login')">
                æœƒå“¡ç™»å…¥ / è¨»å†Š
            </button>
        </div>
    </div>
</div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <div id="mainApp" class="hidden">
        <nav class="top-nav">
    <div class="nav-left">
        <div class="logo" onclick="confirmBackToHome()">
            <div class="logo-icon">å™¶</div>
            <div class="logo-text-multilang">
                <span class="lang-tibetan-nav">à½€à½¿à½à½¼à½‚à¼‹à½¢à½²à½‚à¼‹à½ à½›à½²à½“à¼‹à½†à½ºà½“à¼‹à½”à½¼à½ à½²à¼‹à½†à½¼à½¦à¼‹à½€à¾±à½²à¼‹à½¦à¾Ÿà½ºà½‚à½¦à¼‹à½–à½´à¼</span>
                <span class="lang-chinese-nav">å™¶é™€ä»çåƒå¯¶èª²ç¨‹å¹³å°</span>
                <span class="lang-english-nav">Kathok Rigzin Chenpo Dharma Platform</span>
            </div>
        </div>
    </div>
    <div class="nav-right">
        <div class="user-menu-container"> <!-- æ–°å¢å®¹å™¨ -->
            <div class="user-menu" onclick="toggleUserDropdown()"> <!-- ä¿®æ”¹ onclick -->
                <div class="user-avatar" id="userAvatar">è¨ª</div>
                <span id="userName">è¨ªå®¢</span>
                <span class="dropdown-arrow" id="dropdownArrow">â–¼</span> <!-- ä¿®æ”¹ç®­é ­ -->
            </div>
           <div class="user-dropdown hidden" id="userDropdownMenu">
               <div class="dropdown-user-info">
                 <strong id="dropdownUserName">è¨ªå®¢</strong> <!-- JS æœƒæ›´æ–°é€™è£¡ -->
                 <span id="dropdownUserEmail"></span>   <!-- JS æœƒæ›´æ–°é€™è£¡ -->
        </div>
    <!-- .dropdown-item å°‡ç”± JavaScript å‹•æ…‹æ·»åŠ  -->
            </div>
        </div>
    </div>
</nav>

        <!-- (ä¸»æ‡‰ç”¨ç¨‹å¼çš„ main-container, course-sidebar, content-area, authModal ç­‰ HTML çµæ§‹ä¿æŒä¸è®Š) -->
        <!-- ... é€™è£¡æ‡‰è©²æ˜¯ä½ ä¹‹å‰ç‰ˆæœ¬ä¸­ mainApp çš„å®Œæ•´ HTML çµæ§‹ ... -->
        <div class="main-container">
            <aside class="course-sidebar" id="courseSidebar">
                <div class="course-header">
                    <h2 class="course-title-main">èª²ç¨‹å¤§ç¶±</h2>
                </div>
                <div id="loadingCoursesMessage" style="text-align: center; color: #777; padding: 2rem;">è¼‰å…¥èª²ç¨‹ä¸­...</div>
                <div class="chapter-list" id="chapterList">
                    <!-- ç« ç¯€å’Œèª²ç¨‹å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </aside>

            <main class="content-area">
                <div id="welcomeContent"> <!-- ç¢ºä¿é€™å€‹ div å­˜åœ¨ -->
                    <h1>æ­¡è¿ä¾†åˆ°èª²ç¨‹å­¸ç¿’å¹³å°</h1>
                    <p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹èª²ç¨‹é–‹å§‹å­¸ç¿’ã€‚</p>
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23e9ecef'/%3E%3Ctext x='200' y='140' font-family='Arial, sans-serif' font-size='24' fill='%23adb5bd' text-anchor='middle'%3Eé¸æ“‡èª²ç¨‹ä»¥é–‹å§‹%3C/text%3E%3Cpath d='M150 200 L180 170 L220 210 L280 150' stroke='%23adb5bd' stroke-width='3' fill='none'/%3E%3Ccircle cx='100' cy='100' r='20' fill='%23ced4da'/%3E%3Crect x='280' y='80' width='40' height='40' rx='5' fill='%23ced4da'/%3E%3C/svg%3E" alt="èª²ç¨‹é è¦½åœ–ç¤º">
                </div>

                <div id="courseDisplayArea" class="hidden">
                    <div class="video-section">
                        <div class="video-container">
                            <iframe id="youtubePlayer" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    </div>
                    <div class="content-section">
                        <div class="content-tabs">
                            <div class="content-tab active" onclick="switchTab(event, 'overviewTab')">èª²ç¨‹æ¦‚è¦½</div>
                            <div class="content-tab" onclick="switchTab(event, 'transcriptTab')">èª²ç¨‹è¬›ç¾©</div>
                        </div>
                        <div class="tab-content-wrapper">
                            <div id="overviewTab" class="tab-content active">
                                <h3 id="currentLessonTitle">èª²ç¨‹æ¨™é¡Œ</h3>
                                <p id="currentLessonDescription">èª²ç¨‹æè¿°å°‡é¡¯ç¤ºæ–¼æ­¤ã€‚</p>
                            </div>
                            <div id="transcriptTab" class="tab-content">
                                <h3>èª²ç¨‹è¬›ç¾©</h3>
                                <div id="transcriptContent"><p>è¬›ç¾©å…§å®¹å°‡é¡¯ç¤ºæ–¼æ­¤ã€‚</p></div>
                            </div>
                        </div>
                    </div>
                    <div class="bottom-controls">
                        <button id="prevLessonBtn" class="control-btn" onclick="previousLesson()" disabled>â† ä¸Šä¸€èª²</button>
                        <button id="nextLessonBtn" class="control-btn primary" onclick="nextLesson()" disabled>ä¸‹ä¸€èª² â†’</button>
                    </div>
                </div>
            </main>
        </div>
    </div>


    <!-- ç™»å…¥/è¨»å†Šå½ˆçª— -->
    <div id="authModal" class="auth-modal hidden">
        <div class="auth-form">
            <button class="close-modal-btn" onclick="closeAuthModal()">âœ•</button>
            <div class="auth-header">
                <div class="auth-logo-modal">å™¶</div>
                <h2 id="authFormTitle">æœƒå“¡ç™»å…¥</h2>
            </div>
            <div class="form-group">
                <label class="form-label" for="emailInput">é›»å­éƒµä»¶</label>
                <input type="email" id="emailInput" class="form-input" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶" required>
            </div>
            <div class="form-group" id="usernameFormGroup" style="display: none;">
                <label class="form-label" for="usernameInput">ä½¿ç”¨è€…åç¨±</label>
                <input type="text" id="usernameInput" class="form-input" placeholder="è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨± (è‡³å°‘3å­—å…ƒ)">
            </div>
            <div class="form-group">
                <label class="form-label" for="passwordInput">å¯†ç¢¼</label>
                <input type="password" id="passwordInput" class="form-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼ (è‡³å°‘6å­—å…ƒ)" required>
            </div>
            <div id="authErrorMessage" class="error-message-modal"></div>
            <div id="authSuccessMessage" class="success-message-modal"></div>
            <button id="authSubmitButton" class="auth-submit-btn" onclick="handleAuth()">
                <span id="authSubmitButtonText">ç™»å…¥</span>
                <span id="authLoadingSpinner" class="loading-spinner hidden"></span>
            </button>
            <div class="auth-switch">
                <span id="authSwitchPromptText">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ</span>
                <a href="#" onclick="event.preventDefault(); toggleAuthMode();" id="authSwitchLinkText">ç«‹å³è¨»å†Š</a>
            </div>
        </div>
    </div>


    <script>
        // ========== Firebase è¨­å®š (ç¡¬ç·¨ç¢¼) ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDaupI9H72MGccVro4HUbsVhcXwSqYZeuU", // è«‹æ›¿æ›æˆä½ çš„ API Key
            authDomain: "kathok-learning-platform.firebaseapp.com",
            projectId: "kathok-learning-platform",
            storageBucket: "kathok-learning-platform.appspot.com",
            messagingSenderId: "288334034961",
            appId: "1:288334034961:web:7eba5e9ab7378ad19c59b0",
            // measurementId: "G-LRV77EC50T" // å¦‚æœæœ‰ç”¨åˆ°ï¼Œå–æ¶ˆè¨»è§£
        };

        let auth;
        let db;

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("CRITICAL ERROR initializing Firebase:", e);
            alert("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚");
        }

        // ========== å…¨åŸŸè®Šæ•¸ ==========
        let currentUser = null;
        let currentPage = 'landing';
        let isLoginMode = true;
        let coursesData = [];
        let currentSelectedCourseIndex = -1;

        // DOM Elements
        const landingPageEl = document.getElementById('landingPageContainer');
        const mainAppEl = document.getElementById('mainApp');
        const authModalEl = document.getElementById('authModal');
        // ... (å…¶ä»–ä½ å¯èƒ½æƒ³å¿«å–çš„å…ƒç´ )

        // ========== åˆå§‹é é¢é¡¯ç¤º ==========
        function initializeAppDisplay() {
            if (auth && auth.currentUser) {
                // onAuthStateChanged æœƒè™•ç†å¾ŒçºŒé‚è¼¯
            } else {
                showLandingPage();
            }
        }

        // ========== é é¢åˆ‡æ›é‚è¼¯ ==========
        function showLandingPage() {
            landingPageEl.classList.remove('hidden');
            mainAppEl.classList.add('hidden');
            currentPage = 'landing';
        }

        function showMainApp() {
            landingPageEl.classList.add('hidden');
            mainAppEl.classList.remove('hidden');
            currentPage = 'main';
            if (coursesData.length === 0) {
                loadCourses();
            } else {
                displayCourses();
            }
            if (currentSelectedCourseIndex === -1 && document.getElementById('welcomeContent')) {
                document.getElementById('welcomeContent').classList.remove('hidden');
                if(document.getElementById('courseDisplayArea')) document.getElementById('courseDisplayArea').classList.add('hidden');
            }
        }

        function confirmBackToHome() {
            if (currentPage === 'main') {
                if (confirm('ç¢ºå®šè¦è¿”å›é¦–é å—ï¼Ÿ')) {
                    currentSelectedCourseIndex = -1; // é‡ç½®é¸ä¸­èª²ç¨‹
                    showLandingPage();
                }
            } else {
                showLandingPage();
            }
        }
        // ... (ä¿ç•™ä½ ä¹‹å‰çš„ JavaScript æ ¸å¿ƒé‚è¼¯: Auth, Firestore, èª²ç¨‹é¡¯ç¤ºç­‰) ...
        // æˆ‘æœƒç¢ºä¿ auth, loadCourses, displayCourses, loadSingleCourse ç­‰å‡½æ•¸èƒ½é…åˆæ–°çš„UI
        // æ³¨æ„ï¼šéœ€è¦èª¿æ•´ updateUserUI ç‚º updateUserNavUI ä»¥æ›´æ–°æ–°çš„é ‚éƒ¨å°èˆªæ¬„

        // ========== èªè­‰ (Auth) ç›¸é—œ ==========
        function showAuthModal(mode = 'login') {
            isLoginMode = (mode === 'login');
            updateAuthModalUI();
            authModalEl.classList.remove('hidden');
        }

        function closeAuthModal() {
            authModalEl.classList.add('hidden');
            clearAuthForm();
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            updateAuthModalUI();
        }

        function updateAuthModalUI() {
            const titleEl = document.getElementById('authFormTitle');
            const submitBtnTextEl = document.getElementById('authSubmitButtonText');
            const switchPromptEl = document.getElementById('authSwitchPromptText');
            const switchLinkEl = document.getElementById('authSwitchLinkText');
            const usernameGroupEl = document.getElementById('usernameFormGroup');

            if (isLoginMode) {
                titleEl.textContent = 'æœƒå“¡ç™»å…¥';
                submitBtnTextEl.textContent = 'ç™»å…¥';
                switchPromptEl.textContent = 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ';
                switchLinkEl.textContent = 'ç«‹å³è¨»å†Š';
                usernameGroupEl.style.display = 'none';
            } else {
                titleEl.textContent = 'è¨»å†Šæ–°å¸³è™Ÿ';
                submitBtnTextEl.textContent = 'è¨»å†Š';
                switchPromptEl.textContent = 'å·²æœ‰å¸³è™Ÿï¼Ÿ';
                switchLinkEl.textContent = 'ç«‹å³ç™»å…¥';
                usernameGroupEl.style.display = 'block';
            }
            clearAuthForm();
        }

        function clearAuthForm() {
            document.getElementById('emailInput').value = '';
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('authErrorMessage').textContent = '';
            document.getElementById('authSuccessMessage').textContent = '';
            document.getElementById('authSubmitButtonText').style.display = 'inline';
            document.getElementById('authLoadingSpinner').classList.add('hidden');
        }

        function setAuthError(message) {
            document.getElementById('authErrorMessage').textContent = message;
            document.getElementById('authSuccessMessage').textContent = '';
        }

        function setAuthSuccess(message) {
            document.getElementById('authSuccessMessage').textContent = message;
            document.getElementById('authErrorMessage').textContent = '';
        }

        async function handleAuth() {
            if (!auth || !db) {
                setAuthError("ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                return;
            }

            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const username = document.getElementById('usernameInput').value.trim();

            if (!email || !password) {
                setAuthError('è«‹å¡«å¯«é›»å­éƒµä»¶å’Œå¯†ç¢¼ã€‚');
                return;
            }
            if (!isLoginMode && !username) {
                setAuthError('è¨»å†Šæ™‚è«‹å¡«å¯«ä½¿ç”¨è€…åç¨±ã€‚');
                return;
            }
             if (!isLoginMode && username.length < 3) {
                setAuthError('ä½¿ç”¨è€…åç¨±è‡³å°‘éœ€è¦3å€‹å­—å…ƒã€‚');
                return;
            }
            if (password.length < 6) {
                setAuthError('å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—å…ƒã€‚');
                return;
            }


            document.getElementById('authSubmitButtonText').style.display = 'none';
            document.getElementById('authLoadingSpinner').classList.remove('hidden');
            setAuthError('');

            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                    setAuthSuccess('ç™»å…¥æˆåŠŸï¼');
                } else {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).set({
                        username: username,
                        email: email,
                        memberLevel: 0,
                        memberLevelName: 'ä¸€èˆ¬æœƒå“¡',
                        joinDate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setAuthSuccess('è¨»å†ŠæˆåŠŸï¼');
                }
                setTimeout(() => {
                    closeAuthModal();
                    // onAuthStateChanged æœƒè™•ç† showMainApp
                }, 1200);

            } catch (error) {
                console.error("Auth Error:", error.code, error.message);
                setAuthError(getFirebaseErrorMessage(error.code));
            } finally {
                document.getElementById('authSubmitButtonText').style.display = 'inline';
                document.getElementById('authLoadingSpinner').classList.add('hidden');
            }
        }

        function getFirebaseErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email': return 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢ºã€‚';
                case 'auth/user-disabled': return 'æ­¤å¸³è™Ÿå·²è¢«åœç”¨ã€‚';
                case 'auth/user-not-found': return 'æ­¤é›»å­éƒµä»¶å°šæœªè¨»å†Šã€‚';
                case 'auth/wrong-password': return 'å¯†ç¢¼éŒ¯èª¤ã€‚';
                case 'auth/email-already-in-use': return 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚';
                case 'auth/weak-password': return 'å¯†ç¢¼å¼·åº¦ä¸è¶³ (è‡³å°‘6å€‹å­—å…ƒ)ã€‚';
                case 'auth/requires-recent-login': return 'æ­¤æ“ä½œéœ€è¦é‡æ–°ç™»å…¥ã€‚';
                case 'auth/too-many-requests': return 'è«‹æ±‚é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                case 'auth/network-request-failed': return 'ç¶²è·¯é€£ç·šå¤±æ•—ã€‚';
                default: return `ç™¼ç”ŸéŒ¯èª¤ (${errorCode})ã€‚`;
            }
        }

        async function loadUserData(firebaseUser) {
            if (!db) return;
            try {
                const userDocRef = db.collection('users').doc(firebaseUser.uid);
                const doc = await userDocRef.get();
                if (doc.exists) {
                    currentUser = { uid: firebaseUser.uid, email: firebaseUser.email, ...doc.data() };
                    if (typeof currentUser.memberLevel === 'undefined') currentUser.memberLevel = 0;
                } else {
                    console.warn(`User document for ${firebaseUser.uid} not found. Creating one with default values.`);
                    const defaultUsername = firebaseUser.email.split('@')[0];
                    currentUser = {
                        uid: firebaseUser.uid,
                        email: firebaseUser.email,
                        username: defaultUsername,
                        memberLevel: 0,
                        memberLevelName: 'ä¸€èˆ¬æœƒå“¡'
                    };
                    // è€ƒæ…®æ˜¯å¦è¦è‡ªå‹•åœ¨ Firestore ä¸­å‰µå»ºæ–‡æª”
                    // await userDocRef.set({ username: defaultUsername, email: firebaseUser.email, memberLevel: 0, joinDate: firebase.firestore.FieldValue.serverTimestamp() });
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                currentUser = { uid: firebaseUser.uid, email: firebaseUser.email, username: 'è¼‰å…¥å¤±æ•—', memberLevel: 0 };
            }
            updateUserNavUI(); // æ›´æ–°é ‚éƒ¨å°èˆªæ¬„
        }

     function updateUserNavUI() {
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    const dropdownUserNameEl = document.getElementById('dropdownUserName');
    const dropdownUserEmailEl = document.getElementById('dropdownUserEmail');
    const userDropdownMenuEl = document.getElementById('userDropdownMenu'); // ç²å–ä¸‹æ‹‰é¸å–®å…ƒç´ 

    if (!userDropdownMenuEl) {
        console.error("userDropdownMenu element not found in updateUserNavUI");
        return;
    }

    // å…ˆæ¸…ç©ºç¾æœ‰çš„ä¸‹æ‹‰é¸å–®é …ç›® (é™¤äº†ç”¨æˆ¶è³‡è¨Šéƒ¨åˆ†)
    const existingItems = userDropdownMenuEl.querySelectorAll('.dropdown-item');
    existingItems.forEach(item => item.remove());

    if (currentUser) {
        const displayName = currentUser.username || currentUser.email.split('@')[0];
        userNameEl.textContent = displayName;
        userAvatarEl.textContent = displayName.charAt(0).toUpperCase();
        if(dropdownUserNameEl) dropdownUserNameEl.textContent = displayName;
        if(dropdownUserEmailEl) dropdownUserEmailEl.textContent = currentUser.email;

        // æ·»åŠ æœƒå“¡ä¸‹æ‹‰é …ç›®
        const switchToGuestItem = document.createElement('a');
        switchToGuestItem.href = "#";
        switchToGuestItem.className = 'dropdown-item';
        switchToGuestItem.textContent = 'åˆ‡æ›ç‚ºè¨ªå®¢æ¨¡å¼';
        switchToGuestItem.onclick = function(event) { event.preventDefault(); switchToGuestMode(); };
        userDropdownMenuEl.appendChild(switchToGuestItem);

        const logoutItem = document.createElement('a');
        logoutItem.href = "#";
        logoutItem.className = 'dropdown-item';
        logoutItem.textContent = 'ç™»å‡º';
        logoutItem.onclick = function(event) { event.preventDefault(); logoutUser(); };
        userDropdownMenuEl.appendChild(logoutItem);

    } else {
        userNameEl.textContent = 'è¨ªå®¢';
        userAvatarEl.textContent = 'è¨ª';
        if(dropdownUserNameEl) dropdownUserNameEl.textContent = 'è¨ªå®¢';
        if(dropdownUserEmailEl) dropdownUserEmailEl.textContent = 'å°šæœªç™»å…¥';

        // æ·»åŠ è¨ªå®¢ä¸‹æ‹‰é …ç›®
        const loginRegisterItem = document.createElement('a');
        loginRegisterItem.href = "#";
        loginRegisterItem.className = 'dropdown-item';
        loginRegisterItem.textContent = 'ç™»å…¥ / è¨»å†Š';
        loginRegisterItem.onclick = function(event) {
            event.preventDefault();
            toggleUserDropdown(); // å…ˆé—œé–‰ä¸‹æ‹‰é¸å–®
            showAuthModal('login'); // ç„¶å¾Œæ‰“é–‹ç™»å…¥æ¨¡æ…‹æ¡†
        };
        userDropdownMenuEl.appendChild(loginRegisterItem);
    }
}

        function enterAsGuest() {
            if (auth && auth.currentUser) {
                auth.signOut().then(() => {
                    currentUser = null; // ç¢ºä¿ currentUser è¢«æ¸…ç©º
                    updateUserNavUI();
                    showMainApp();
                });
            } else {
                currentUser = null;
                updateUserNavUI();
                showMainApp();
            }
        }

        async function loadCourses() {
            if (!db) return;
            const loadingMsgEl = document.getElementById('loadingCoursesMessage');
            loadingMsgEl.style.display = 'block';
            loadingMsgEl.textContent = 'è¼‰å…¥èª²ç¨‹ä¸­...';
            document.getElementById('chapterList').innerHTML = '';

            try {
                const snapshot = await db.collection('courses').orderBy('order', 'asc').get(); // ç¢ºä¿æœ‰ 'order' æ¬„ä½
                coursesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayCourses();
                loadingMsgEl.style.display = 'none';
            } catch (error) {
                console.error("Error loading courses:", error);
                loadingMsgEl.textContent = 'è¼‰å…¥èª²ç¨‹å¤±æ•—ã€‚';
            }
        }

function displayCourses() {
    const chapterListEl = document.getElementById('chapterList');
    if (!chapterListEl) { // æª¢æŸ¥ DOM å…ƒç´ 
        console.error("chapterList element not found in displayCourses.");
        return;
    }
    chapterListEl.innerHTML = ''; // æ¸…ç©º
    const userLevel = currentUser ? (currentUser.memberLevel || 0) : 0;
    console.log("Displaying courses for userLevel:", userLevel, "Current user:", currentUser); // æ—¥èªŒ

    const coursesByCategory = {};
    if (!coursesData || coursesData.length === 0) { // æª¢æŸ¥ coursesData æ˜¯å¦æœ‰æ•¸æ“š
        console.log("No courses data to display.");
        chapterListEl.innerHTML = '<p style="padding: 1rem; text-align: center; color: #888;">ç›®å‰æ²’æœ‰èª²ç¨‹ã€‚</p>';
        return;
    }

    coursesData.forEach(course => {
        const category = course.category || 'æ‰€æœ‰èª²ç¨‹';
        if (!coursesByCategory[category]) coursesByCategory[category] = [];
        coursesByCategory[category].push(course);
    });

    if (Object.keys(coursesByCategory).length === 0 && coursesData.length > 0) {
         coursesByCategory['æ‰€æœ‰èª²ç¨‹'] = [...coursesData];
    }

    let globalLessonCounter = 0;
    Object.keys(coursesByCategory).sort().forEach((category, categoryIndex) => {
        const chapterDiv = document.createElement('div');
        chapterDiv.className = 'chapter';
        if (categoryIndex === 0) chapterDiv.classList.add('expanded');

        let lessonsHTML = '';
        coursesByCategory[category].forEach(course => {
            const requiredLevel = typeof course.requiredLevel === 'number' ? course.requiredLevel : 0;
            const isLocked = requiredLevel > userLevel;
            // const courseGlobalIndex = coursesData.findIndex(c => c.id === course.id); // é€™ä¸€è¡Œå¯ä»¥ç°¡åŒ–ï¼Œå› ç‚ºæˆ‘å€‘æ˜¯éæ­· coursesData è™•ç†çš„
            const courseGlobalIndex = coursesData.indexOf(course);


            // æª¢æŸ¥ course.title æ˜¯å¦å­˜åœ¨
            const courseTitle = course.title ? course.title.replace(/'/g, "\\'") : "æœªçŸ¥æ¨™é¡Œ";

            lessonsHTML += `
                <div class="lesson ${isLocked ? 'locked' : ''} ${currentSelectedCourseIndex === courseGlobalIndex ? 'active' : ''}"
                     data-course-index="${courseGlobalIndex}"
                     onclick="handleLessonClick(${courseGlobalIndex}, ${isLocked}, '${courseTitle}', ${requiredLevel})">
                    <div class="lesson-icon-wrapper"><span class="lesson-icon">${globalLessonCounter + 1}</span></div>
                    <div class="lesson-info">
                        <div class="lesson-title">${course.title || "æœªçŸ¥æ¨™é¡Œ"}</div>
                        <div class="lesson-duration">${course.duration || ''}</div>
                    </div>
                </div>
            `;
            globalLessonCounter++;
        });

        chapterDiv.innerHTML = `
            <div class="chapter-title" onclick="toggleChapterExpansion(this)">
                <span>${category}</span>
                <span class="chapter-icon">${categoryIndex === 0 ? 'â–¼' : 'â–¶'}</span>
            </div>
            <div class="lesson-list">${lessonsHTML}</div>
        `;
        chapterListEl.appendChild(chapterDiv);
    });

     if (globalLessonCounter === 0) { // å†æ¬¡æª¢æŸ¥ï¼Œå¦‚æœåˆ†é¡å¾Œæ²’æœ‰èª²ç¨‹
         chapterListEl.innerHTML = '<p style="padding: 1rem; text-align: center; color: #888;">ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„èª²ç¨‹ã€‚</p>';
     }
}


        function toggleChapterExpansion(chapterTitleElement) {
            chapterTitleElement.parentElement.classList.toggle('expanded');
            const icon = chapterTitleElement.querySelector('.chapter-icon');
            icon.textContent = chapterTitleElement.parentElement.classList.contains('expanded') ? 'â–¼' : 'â–¶';
        }

        function handleLessonClick(courseIndex, isLocked, courseTitle, requiredLevel) {
            if (isLocked) {
                const userLevel = currentUser ? (currentUser.memberLevel || 0) : 0;
                if (currentUser) {
                    alert(`æŠ±æ­‰ï¼Œã€Œ${courseTitle}ã€éœ€è¦æœƒå“¡ç­‰ç´š ${requiredLevel} æ‰èƒ½è§€çœ‹ã€‚\næ‚¨ç›®å‰çš„ç­‰ç´šæ˜¯ ${userLevel}ã€‚`);
                } else {
                    alert('è«‹å…ˆç™»å…¥ä»¥è§€çœ‹æ­¤é€²éšèª²ç¨‹ã€‚');
                    showAuthModal('login');
                }
                return;
            }
            loadSingleCourse(courseIndex);
        }

function loadSingleCourse(courseIndex) {
    // 1. åƒæ•¸æœ‰æ•ˆæ€§æª¢æŸ¥ (é€™éƒ¨åˆ†ä½ å·²ç¶“æœ‰äº†)
    if (courseIndex < 0 || courseIndex >= coursesData.length) {
        console.warn("Invalid course index for loadSingleCourse:", courseIndex);
        return;
    }
    currentSelectedCourseIndex = courseIndex; // æ›´æ–°å…¨åŸŸé¸ä¸­ç´¢å¼• (é€™éƒ¨åˆ†ä½ å¯èƒ½ä¹Ÿæœ‰)

    // 2. â†“â†“â†“ åœ¨é€™è£¡æ·»åŠ ç¼ºå¤±çš„è¡Œ â†“â†“â†“
    const course = coursesData[courseIndex];

    // 3. å° course ç‰©ä»¶æœ¬èº«é€²è¡Œæª¢æŸ¥ (é€™æ˜¯ä¸€å€‹å¥½ç¿’æ…£)
    if (!course) {
        console.error("Course object is undefined for index:", courseIndex, "coursesData:", coursesData);
        // å¯ä»¥åœ¨é€™è£¡é¡¯ç¤ºä¸€å€‹ç”¨æˆ¶æç¤ºï¼Œä¾‹å¦‚ "ç„¡æ³•è¼‰å…¥æ‰€é¸èª²ç¨‹è³‡æ–™ã€‚"
        // æˆ–è€…å˜—è©¦éš±è—èª²ç¨‹é¡¯ç¤ºå€åŸŸï¼Œé¡¯ç¤ºæ­¡è¿è¨Šæ¯
        if(document.getElementById('courseDisplayArea')) document.getElementById('courseDisplayArea').classList.add('hidden');
        if(document.getElementById('welcomeContent')) document.getElementById('welcomeContent').classList.remove('hidden');
        return;
    }

    // 4. å¾ŒçºŒä½¿ç”¨ course è®Šæ•¸çš„ç¨‹å¼ç¢¼ (ä¿æŒä¸è®Šæˆ–æ ¹æ“šéœ€è¦èª¿æ•´)
    console.log("Loading single course:", course.title, course);

    document.querySelectorAll('.lesson').forEach(el => el.classList.remove('active'));
    const activeLessonEl = document.querySelector(`.lesson[data-course-index="${courseIndex}"]`);
    if (activeLessonEl) {
        activeLessonEl.classList.add('active');
    } else {
        console.warn("Could not find lesson element with data-course-index:", courseIndex);
    }

    if(document.getElementById('welcomeContent')) document.getElementById('welcomeContent').classList.add('hidden');
    if(document.getElementById('courseDisplayArea')) document.getElementById('courseDisplayArea').classList.remove('hidden');

    document.getElementById('currentLessonTitle').textContent = course.title || "æœªçŸ¥æ¨™é¡Œ";
    const descriptionHTML = course.description ? course.description.replace(/\n/g, '<br>') : 'æš«ç„¡èª²ç¨‹æ¦‚è¦½ã€‚';
    document.getElementById('currentLessonDescription').innerHTML = descriptionHTML;

    const transcriptHTML = course.transcript ? course.transcript.replace(/\n/g, '<br>') : '<p>æš«ç„¡èª²ç¨‹è¬›ç¾©ã€‚</p>';
    document.getElementById('transcriptContent').innerHTML = transcriptHTML;

    const youtubePlayer = document.getElementById('youtubePlayer');
    let videoSrc = '';
    // ä½¿ç”¨æˆ‘ä¹‹å‰å»ºè­°çš„ä¿®æ”¹å¾Œçš„å½±ç‰‡ src è¨­å®šé‚è¼¯
    if (course.playlistId && String(course.playlistId).trim() !== "") {
        videoSrc = `https://www.youtube.com/embed/videoseries?list=${String(course.playlistId).trim()}&autoplay=0&showinfo=1&controls=1&loop=0`;
    } else if (course.youtubeVideoId && String(course.youtubeVideoId).trim() !== "") {
        videoSrc = `https://www.youtube.com/embed/${String(course.youtubeVideoId).split('&')[0]}?modestbranding=1&rel=0&autoplay=0`;
    } else {
        console.log("No video ID or playlist ID for course:", course.title || "Unknown Title");
        videoSrc = "";
    }
    youtubePlayer.src = videoSrc;
    console.log("Set video src to:", videoSrc);

    updateNavigationButtons();
    switchTab(null, 'overviewTab', true);
}
        function previousLesson() {
            if (currentSelectedCourseIndex > 0) {
                loadSingleCourse(currentSelectedCourseIndex - 1);
            }
        }

        function nextLesson() {
            if (currentSelectedCourseIndex < coursesData.length - 1) {
                loadSingleCourse(currentSelectedCourseIndex + 1);
            }
        }

        function updateNavigationButtons() {
            document.getElementById('prevLessonBtn').disabled = currentSelectedCourseIndex <= 0;
            document.getElementById('nextLessonBtn').disabled = currentSelectedCourseIndex >= coursesData.length - 1;
        }

        function switchTab(event, tabId, isDefault = false) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.content-tab').forEach(tb => tb.classList.remove('active'));
            let targetTabButton;
            if (event && event.currentTarget) {
                 targetTabButton = event.currentTarget;
            } else if (isDefault) {
                const tabs = document.querySelectorAll('.content-tab');
                for (let tab of tabs) {
                    if (tab.getAttribute('onclick').includes(tabId)) {
                        targetTabButton = tab;
                        break;
                    }
                }
            }
            if (targetTabButton) targetTabButton.classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase !== 'undefined' && auth && db) {
                initializeAppDisplay();
            } else {
                showLandingPage();
            }
            const authModalInputs = ['emailInput', 'usernameInput', 'passwordInput'];
            authModalInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' && !authModalEl.classList.contains('hidden')) {
                            handleAuth();
                        }
                    });
                }
            });
        });

        window.addEventListener('click', function(event) {
            if (event.target === authModalEl) {
                closeAuthModal();
            }
        });

    </script>
</body>
</html>